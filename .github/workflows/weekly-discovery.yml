name: Weekly Content Discovery

on:
  schedule:
    # Every Sunday at 9:00 AM UTC (2:30 PM IST)
    - cron: '0 9 * * 0'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  discover:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run discovery script
        run: npx tsx scripts/weekly-scraper.ts discover
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Check if pending resources exist
        id: check_pending
        run: |
          if [ -f scripts/pending-resources.json ]; then
            echo "has_pending=true" >> $GITHUB_OUTPUT
            echo "pending_count=$(jq length scripts/pending-resources.json)" >> $GITHUB_OUTPUT
          else
            echo "has_pending=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_pending.outputs.has_pending == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: weekly content discovery - ${{ steps.check_pending.outputs.pending_count }} resources'
          branch: scraper-results-${{ github.run_number }}
          delete-branch: true
          title: 'ðŸ“¦ Weekly Content Discovery - ${{ steps.check_pending.outputs.pending_count }} Resources'
          body: |
            ## Weekly Content Discovery

            Found **${{ steps.check_pending.outputs.pending_count }}** new resources for review.

            ### ðŸ“‹ Review Instructions
            1. Review `scripts/pending-resources.json`
            2. Set `"approved": true` for items you want to import
            3. Commit your changes to this PR
            4. Merge this PR to trigger automatic import

            ### ðŸ“Š Discovery Sources
            - GitHub MCP servers
            - Vercel templates
            - n8n workflows
            - Awesome lists

            ---
            ðŸ¤– This PR was created automatically by the weekly scraper.

      - name: Send email notification
        if: steps.check_pending.outputs.has_pending == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: 'ðŸ“¦ Weekly Content Discovery: ${{ steps.check_pending.outputs.pending_count }} New Resources Found'
          to: ${{ secrets.ADMIN_EMAIL }}
          from: Google Antigravity Directory <noreply@googleantigravity.directory>
          body: |
            Hi there! ðŸ‘‹

            The weekly content discovery script has found ${{ steps.check_pending.outputs.pending_count }} new resources for review.

            ðŸ“‹ REVIEW PENDING RESOURCES:
            https://github.com/${{ github.repository }}/pull/${{ steps.create_pr.outputs.pull-request-number }}

            ðŸ”Ž APPROVE RESOURCES:
            1. Review the pending-resources.json file in the PR
            2. Edit the file directly on GitHub
            3. Set "approved": true for items you want
            4. Commit changes
            5. Merge the PR to import automatically

            ðŸ“Š CURRENT STATS:
            - Total Resources: 499
            - Indexed Resources: 104

            ðŸ”— QUICK LINKS:
            - View PR: https://github.com/${{ github.repository }}/pull/${{ steps.create_pr.outputs.pull-request-number }}
            - Live Site: https://googleantigravity.directory

            ---
            This is an automated message from Google Antigravity Directory.
          attachments: scripts/pending-resources.json
